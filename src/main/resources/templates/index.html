<!DOCTYPE html>
<html lang="zh">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>seven-im, ä¸€ä¸ªèœåˆ°ä¸è¡Œçš„å³æ—¶é€šè®¯</title>
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon"/>
    <link href="https://www.layuicdn.com/layui/css/layui.css" rel="stylesheet">
    <link href="/css/index.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://cdn.bootcss.com/lodash.js/4.17.15/lodash.core.js"></script>
    <script src="https://www.layuicdn.com/layui/layui.js"></script>
</head>
<body>
<div class="project">seven-im, ä¸€ä¸ªèœåˆ°ä¸è¡Œçš„å³æ—¶é€šè®¯</div>
<div class="im-container">
    <div class="mask"></div>
    <div class="session-list-container"></div>
    <div class="session-container">
        <div class="top">
            <div class="curr-seesion-name"></div>
            <div class="user-info">
                <img class="current-user-avatar" src="images/avatar.jpg" style="width: 24px;height: 24px;"/>
                <div class="current-user">æœªç™»å½•</div>
            </div>
        </div>
        <div style="display: flex;flex-direction: row;justify-content: stretch;height: 536px;overflow: auto;">
            <div class="center">
                <div class="information"></div>
                <div class="operation" style="position: relative;">
                    <div class="emoji-container">
                        <span class="emoji" title="ç¬‘å˜»å˜»">ğŸ˜€</span>
                        <span class="emoji" title="ç¬‘å˜»å˜»çš„è„¸ï¼Œå«ç¬‘çš„çœ¼ç›">ğŸ˜</span>
                        <span class="emoji" title="è„¸ä¸Šå¸¦ç€å–œæ‚¦çš„æ³ªæ°´">ğŸ˜‚</span>
                        <span class="emoji" title="å¼€å£ç¬‘è„¸">ğŸ˜ƒ</span>
                        <span class="emoji" title="å¼€å£ç¬‘è„¸å’Œå¾®ç¬‘çš„çœ¼ç›">ğŸ˜„</span>
                        <span class="emoji" title="ç¬‘è„¸æ·Œå†·æ±—">ğŸ˜…</span>
                        <span class="emoji" title="å¼€å£ç¬‘ç´§é—­çš„çœ¼ç›">ğŸ˜†</span>
                        <span class="emoji" title="çœ¨çœ¼è¡¨æƒ…">ğŸ˜‰</span>
                        <span class="emoji" title="é¢å¸¦å¾®ç¬‘çš„çœ¼ç›">ğŸ˜Š</span>
                        <span class="emoji" title="å“å°ç¾å‘³é£Ÿç‰©è¡¨æƒ…">ğŸ˜‹</span>
                        <span class="emoji" title="å¤ªé˜³é•œç¬‘è„¸">ğŸ˜</span>
                        <span class="emoji" title="é¢å¸¦å¿ƒå½¢çœ¼ç›">ğŸ˜</span>
                        <span class="emoji" title="é£å»è¡¨æƒ…">ğŸ˜˜</span>
                        <span class="emoji" title="äº²å»è¡¨æƒ…">ğŸ˜—</span>
                        <span class="emoji" title="å«ç¬‘äº²å»è¡¨æƒ…">ğŸ˜™</span>
                        <span class="emoji" title="é—­çœ¼äº²å»è¡¨æƒ…">ğŸ˜š</span>
                        <span class="emoji" title="å…‰ç¯ç¬‘è„¸">ğŸ˜‡</span>
                        <span class="emoji" title="ä¸­æ€§é¢">ğŸ˜</span>
                        <span class="emoji" title="é¢æ— è¡¨æƒ…">ğŸ˜‘</span>
                        <span class="emoji" title="æ²¡æœ‰å˜´çš„è„¸">ğŸ˜¶</span>
                        <span class="emoji" title="å‚»ç¬‘">ğŸ˜</span>
                        <span class="emoji" title="åšæŒ">ğŸ˜£</span>
                        <span class="emoji" title="å¤±æœ›å¾—åˆ°å®½æ…°çš„è„¸">ğŸ˜¥</span>
                        <span class="emoji" title="å¼ ç€å˜´">ğŸ˜®</span>
                        <span class="emoji" title="å®‰é™çš„è„¸">ğŸ˜¯</span>
                        <span class="emoji" title="å›°">ğŸ˜ª</span>
                        <span class="emoji" title="ç–²æƒ«">ğŸ˜«</span>
                        <span class="emoji" title="ç†Ÿç¡">ğŸ˜´</span>
                        <span class="emoji" title="å®‰å¿ƒ">ğŸ˜Œ</span>
                        <span class="emoji" title="åèˆŒå¤´">ğŸ˜›</span>
                        <span class="emoji" title="åèˆŒå¤´ï¼Œçœ¨çœ¼çœ¼">ğŸ˜œ</span>
                        <span class="emoji" title="é—­çœ¼åèˆŒå¤´">ğŸ˜</span>
                        <span class="emoji" title="å‚å¤´ä¸§æ°”">ğŸ˜’</span>
                        <span class="emoji" title="å†·æ±—">ğŸ˜“</span>
                        <span class="emoji" title="æ²‰æ€">ğŸ˜”</span>
                        <span class="emoji" title="å›°æƒ‘">ğŸ˜•</span>
                        <span class="emoji" title="æƒŠè®¶">ğŸ˜²</span>
                        <span class="emoji" title="æˆ´å£ç½©">ğŸ˜·</span>
                        <span class="emoji" title="è¢«æ‰“è´¥">ğŸ˜–</span>
                        <span class="emoji" title="å¤±æœ›">ğŸ˜</span>
                        <span class="emoji" title="å¿§ä¼¤">ğŸ˜Ÿ</span>
                        <span class="emoji" title="é¢å¸¦èƒœåˆ©">ğŸ˜¤</span>
                        <span class="emoji" title="å“­æ³£çš„è„¸">ğŸ˜¢</span>
                        <span class="emoji" title="å¤§å£°å“­æ³£çš„è„¸">ğŸ˜­</span>
                        <span class="emoji" title="å¼ å˜´å“­">ğŸ˜¦</span>
                        <span class="emoji" title="ç—›è‹¦">ğŸ˜§</span>
                        <span class="emoji" title="ææƒ§">ğŸ˜¨</span>
                        <span class="emoji" title="ç‹°ç‹">ğŸ˜¬</span>
                        <span class="emoji" title="æ·Œå†·æ±—">ğŸ˜°</span>
                        <span class="emoji" title="å°–å«ææƒ§">ğŸ˜±</span>
                        <span class="emoji" title="çº¢æ‰‘æ‰‘çš„è„¸è›‹">ğŸ˜³</span>
                        <span class="emoji" title="æ™•">ğŸ˜µ</span>
                        <span class="emoji" title="å™˜å˜´">ğŸ˜¡</span>
                        <span class="emoji" title="æ„¤æ€’">ğŸ˜ </span>
                        <span class="emoji" title="é•¿è§’çš„ç¬‘è„¸">ğŸ˜ˆ</span>
                        <span class="emoji" title="æ¶é­”">ğŸ‘¿</span>
                        <span class="emoji" title="æ—¥æœ¬é£Ÿäººé­”">ğŸ‘¹</span>
                        <span class="emoji" title="æ—¥æœ¬å“¥å¸ƒæ—">ğŸ‘º</span>
                        <span class="emoji" title="å¤´éª¨">ğŸ’€</span>
                        <span class="emoji" title="éª·é«…å¤´">â˜ </span>
                        <span class="emoji" title="é¬¼">ğŸ‘»</span>
                        <span class="emoji" title="å¤–æ˜Ÿå¼‚å½¢">ğŸ‘½</span>
                    </div>
                    <div class="tools">
                        <i class="layui-icon layui-icon-face-smile-b" title="è¡¨æƒ…" onclick="showEmoji()"></i>
                        <i class="layui-icon layui-icon-picture" title="å›¾ç‰‡" onclick="uploadImg()"></i>
                        <i class="layui-icon layui-icon-file" title="æ–‡ä»¶" onclick="uploadFile()"></i>
                        <form id="imgForm" style="display: none;">
                            <input id="imgFile" type="file" accept="image/jpeg, image/gif, image/png">
                        </form>
                        <form id="fileForm" style="display: none;">
                            <input id="file" type="file" accept="*">
                        </form>
                    </div>
                    <textarea class="typing"></textarea>
                    <button type="button" class="layui-btn layui-btn-normal layui-btn-sm" onclick="sendMsg()"
                            style="position: absolute;right: 12px;bottom: 12px;">å‘é€
                    </button>
                </div>
            </div>
            <div class="right">
                <div class="group-users">
                    <div style="padding: 6px;">
                        <span>æˆå‘˜(</span><span id="current-total">0</span>/<span id="history-total">0</span>)
                    </div>
                    <div class="group-users-list"></div>
                </div>
                <div class="friend-user-container">
                    <img class="friend-user-avatar" src="images/avatar.jpg"/>
                    <div class="friend-user"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">

    const chatContext = {
        curUser: {id: '', name: '', avatar: ''},
        curSession: {id: '', name: '', avatar: '', type: '', chatLog: '', unread: []},
        contacts: {},
        sessions: [],
        socket: null,
        ui: {
            info: msg => {
                $('.information').append(`<div style="text-align:center;color:#aca;margin:24px auto;">${msg}</div>`).scrollTop($('.information')[0].scrollHeight);
            },
            self: msg => {
                const h = `
                    <div class="info info-self">
                        <div class="content content-self">
                            <div class="name">${moment(msg.sendTime).format('MM-DD HH:mm:ss')} ${msg.fromName}</div>
                            <div class="text text-self">${dealContent(msg.content)}</div>
                        </div>
                        <img class="avatar" src="images/${chatContext.curUser.avatar}">
                    </div>
                `;
                $('.information').append(h).scrollTop($('.information')[0].scrollHeight);
            },
            other: msg => {
                const other = getOther(msg.fromId);
                const h = `
                    <div class="info info-other">
                        <img class="avatar" src="images/${other.avatar}">
                        <div class="content content-other">
                            <div class="name">${other.name} ${moment(msg.sendTime).format('MM-DD HH:mm:ss')}</div>
                            <div class="text">${dealContent(msg.content)}</div>
                        </div>
                    </div>
                `;
                $('.information').append(h).scrollTop($('.information')[0].scrollHeight);
            }
        }
    };

    // è·å–èŠå¤©æ¶ˆæ¯å¯¹è±¡
    const getOther = otherId => {
        if (chatContext.curSession.type === 'group' || chatContext.curSession.type === 'public') {
            return _.find(chatContext.curSession.users, {'id': otherId});
        } else {
            return chatContext.curSession;
        }
    };

    const sendMsg = () => {
        const text = $('.typing').val();
        if (text !== '') {
            const msg = {
                fromId: chatContext.curUser.id,
                fromName: chatContext.curUser.name,
                fromAvatar: chatContext.curUser.avatar,
                toId: chatContext.curSession.id,
                toName: chatContext.curSession.name,
                toAvatar: chatContext.curSession.avatar,
                type: chatContext.curSession.type === 'user' ? 'TYPE_ONE' : 'TYPE_GROUP',
                msgType: 'text',
                content: text,
                time: null
            };
            chatContext.socket.send(JSON.stringify(msg));
            $('.typing').val('');
        }
    };

    const joinGroup = group => {
        $.post('/im/joinGroup', {groupId: group.id, userId: chatContext.curUser.id}, res => {
            if (res.code === 200) {
                const msg = {
                    fromId: chatContext.curUser.id,
                    fromName: chatContext.curUser.name,
                    toId: group.id,
                    toName: group.name,
                    type: 'TYPE_SYSTEM',
                    msgType: 'MSG_TYPE_JOIN',
                    content: ''
                };
                chatContext.socket.send(JSON.stringify(msg));
                getContacts();
            }
        });
    };

    const getContacts = () => {
        $.get(`/im/getContacts/${chatContext.curUser.id}`, res => {
            if (res.code === 200) {
                chatContext.contacts = res.data;
                chatContext.contacts.groups.forEach(v => generateSessionItem(v, v.type));
                chatContext.contacts.friends.forEach(v => generateSessionItem(v, 'user'));
                $(`#${chatContext.contacts.groups[0].id}`).trigger('click');
            }
        });
    };

    const getPublicGroup = () => {
        $.get('/im/getPublicGroup', res => {
            if (res.code === 200) {
                joinGroup(res.data[0]);
            }
        });
    };

    const generateSessionItem = (item, type) => {
        const h = `
            <div id="${item.id}" class="session-item ${type == 'user' ? item.status == 1 ? '' : 'gray' : ''}" onclick="chat('${item.id}')">
                <div style="display: flex;justify-content: space-between;align-items: center;">
                    <div style="display: flex;align-items: center;">
                        <div class="session-avatar">
                            <img src="images/${item.avatar}">
                        </div>
                        <div style="margin-left: 10px;">${item.name}</div>
                    </div>
                    <div class="unread"></div>
                </div>
            </div>
        `;
        $('.session-list-container').append(h);
        item.type = type;
        item.chatLog = '';
        item.unread = [];
        chatContext.sessions.push(item);
    };

    const chat = id => {
        if (chatContext.curSession.id !== '') {
            chatContext.curSession.chatLog = $('.information').html();
        }
        chatContext.curSession = _.find(chatContext.sessions, {'id': id});
        $('.information').html(chatContext.curSession.chatLog);
        chatContext.curSession.unread.forEach(v => chatContext.ui.other(v));
        chatContext.curSession.unread = [];
        $(`#${chatContext.curSession.id} .unread`).css('display', 'none');
        $('.information').scrollTop($('.information')[0].scrollHeight);

        if (chatContext.curSession.type === 'group' || chatContext.curSession.type === 'public') {
            chat2Group();
        } else {
            chat2User();
        }
        $('.curr-seesion-name').html(chatContext.curSession.name);
        $('.session-item').removeClass('session-item-active ');
        $(`#${id}`).addClass('session-item-active ');
    };

    const chat2Group = () => {
        $('.friend-user-container').css('display', 'none');
        $('.group-users').show();
        getGroupUsers(chatContext.curSession.id);
    };

    const chat2User = () => {
        $('.group-users').hide();
        $('.friend-user-container').css('display', 'flex');
        $('.friend-user-avatar').attr('src', `images/${chatContext.curSession.avatar}`);
        $('.friend-user').html(chatContext.curSession.name);
    };

    const getGroupUsers = groupId => {
        $.get(`/im/getGroupUsers/${groupId}`, res => {
            $('.group-users-list').html('');
            $('#current-total').html(_.filter(res.data, {'status': 1}).length);
            $('#history-total').html(res.data.length);
            chatContext.curSession['users'] = res.data;
            if (chatContext.curSession.users.length > 0) {
                chatContext.curSession.users.forEach(v => {
                    if (v.name.length > 7) {
                        v.name = v.name.slice(0, 7) + '...'
                    }
                    const h = `
                        <div class="online-user ${v.status === 0 ? 'gray' : ''}" onclick="clickGroupUser('${v.id}')">
                            <img class="avatar" src="images/${v.avatar}">
                            <span class="nickname">${v.name}</span>
                        </div>
                    `;
                    $('.group-users-list').append(h);

                });
            }
        });
    };

    const clickGroupUser = userId => {
        const session = _.find(chatContext.sessions, {'id': userId});
        if (!session) {
            const user = _.find(chatContext.curSession.users, {'id': userId});
            generateSessionItem(user, 'user');
        }
        $(`#${userId}`).trigger('click');
    }

    const showEmoji = () => $('.mask,.emoji-container').show();

    const uploadImg = () => $('#imgFile').trigger('click');

    const uploadFile = () => $('#file').trigger('click');

    const dealContent = msg => {
        if (/^(\[FILE\]:)+[A-Za-z0-9]+:[A-Za-z0-9]+.+[A-Za-z0-9]:[0-9]/.test(msg)) {
            const str = msg.split(":");
            return `<a target="_blank" href="im/download/${str[1]}" style="text-decoration: underline;color: white;">${str[2]} - ${(str[3] / 1024 / 1024).toFixed(2)}MB</a>`;
        } else if (/^(\[IMG\]:)+[A-Za-z0-9]/.test(msg)) {
            const str = msg.split(":");
            return `<img src="im/download/${str[1]}" style="max-width: 80%;cursor: pointer;" onclick="window.open('im/download/${str[1]}')">`;
        } else {
            return msg;
        }
    };

    const init = () => {
        $('.mask').on('click', e => {
            $('.mask,.emoji-container').hide();
        });

        $('.emoji-container span').on('click', function (e) {
            $('.mask,.emoji-container').hide();
            let val = $('.typing').val();
            val += $(this).html();
            $('.typing').val(val).focus();
        });

        $('#imgFile').on('change', e => {
            const formData = new FormData();
            formData.append("file", $('#imgFile')[0].files[0]);
            $.ajax({
                url: '/im/upload',
                dataType: 'json',
                type: 'POST',
                async: false,
                data: formData,
                processData: false, // ä½¿æ•°æ®ä¸åšå¤„ç†
                contentType: false, // ä¸è¦è®¾ç½®Content-Typeè¯·æ±‚å¤´
                success: r => {
                    if (r.code === 200) {
                        $('.typing').val(`[IMG]:${r.data.id}`);
                        sendMsg();
                    }
                }
            });
        });

        $('#file').on('change', e => {
            const formData = new FormData();
            formData.append("file", $('#file')[0].files[0]);
            $.ajax({
                url: '/im/upload',
                dataType: 'json',
                type: 'POST',
                async: false,
                data: formData,
                processData: false, // ä½¿æ•°æ®ä¸åšå¤„ç†
                contentType: false, // ä¸è¦è®¾ç½®Content-Typeè¯·æ±‚å¤´
                success: r => {
                    if (r.code === 200) {
                        $('.typing').val(`[FILE]:${r.data.id}:${r.data.name}:${r.data.size}`);
                        sendMsg();
                    }
                }
            });
        });
    };

    // æ³¨å†Œ
    const register = name => {
        $.post('/im/register', {name: name, avatar: `${Math.round(Math.random() * 9)}.jpg`, gender: 1}, res => {
            if (res.code === 200) {
                chatContext.curUser = res.data;
                $(".current-user").html(chatContext.curUser.name);
                $(".current-user-avatar").attr('src', `images/${chatContext.curUser.avatar}`);
                createWebsocket();
            }
        });
    };

    const createWebsocket = () => {
        if (!window.WebSocket) {
            window.WebSocket = window.MozWebSocket;
        }
        chatContext.socket = new WebSocket(`ws://${window.location.host}/im/${chatContext.curUser.id}`);
        chatContext.socket.onmessage = event => {
            const imMessage = JSON.parse(event.data);
            switch (imMessage.type) {
                case "TYPE_SYSTEM":
                    switch (imMessage.msgType) {
                        case "MSG_TYPE_JOIN":
                            if (chatContext.curSession.id == imMessage.toId) {
                                chatContext.ui.info(`${imMessage.fromName} åŠ å…¥äº†`);
                                getGroupUsers(imMessage.toId);
                            }
                            break;
                        case "MSG_TYPE_LEAVE":
                            if (chatContext.curSession.id == imMessage.toId) {
                                chatContext.ui.info(`${imMessage.fromName} ç¦»å¼€äº†`);
                                getGroupUsers(imMessage.toId);
                            }
                            break;
                        case "MSG_TYPE_FORCE_LEAVE":
                            layer.msg('æ‚¨çš„è´¦å·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•äº†,è¢«è¿«ä¸‹çº¿äº†...');
                            break;
                    }
                    break;
                case "TYPE_GROUP":
                    if (imMessage.toId === chatContext.curSession.id) { // æ”¶åˆ°çš„æ¶ˆæ¯æ˜¯å½“å‰ä¼šè¯
                        if (imMessage.fromId === chatContext.curUser.id) {
                            chatContext.ui.self(imMessage);
                        } else {
                            chatContext.ui.other(imMessage);
                        }
                    } else { // æ”¶åˆ°çš„æ¶ˆæ¯ä¸æ˜¯å½“å‰ä¼šè¯
                        const session = _.find(chatContext.sessions, {'id': imMessage.toId});
                        session.unread.push(imMessage);
                        $(`#${imMessage.toId} .unread`).html(session.unread.length).css('display', 'block');
                    }
                    break;
                case "TYPE_ONE":
                    if (imMessage.fromId === chatContext.curUser.id) { // è‡ªå·±å‘é€çš„æ¶ˆæ¯
                        chatContext.ui.self(imMessage);
                    } else { // æ”¶åˆ°çš„æ¶ˆæ¯
                        if (imMessage.fromId === chatContext.curSession.id) { // å‘é€è€…å·²åœ¨ä¼šè¯åˆ—è¡¨
                            chatContext.ui.other(imMessage);
                        } else { // å‘é€è€…æœªåœ¨ä¼šè¯åˆ—è¡¨,åˆ™åˆ›å»ºæ–°çš„åˆ—è¡¨
                            let session = _.find(chatContext.sessions, {'id': imMessage.fromId});
                            if (!session) {
                                session = {
                                    id: imMessage.fromId,
                                    name: imMessage.fromName,
                                    avatar: imMessage.fromAvatar,
                                    type: 'user',
                                    status: 1,
                                    chatLog: '',
                                    unread: []
                                };
                                generateSessionItem(session, 'user');
                            }
                            session.unread.push(imMessage);
                            $(`#${imMessage.fromId} .unread`).html(session.unread.length).css('display', 'block');
                        }
                    }
                    break;
            }
        };
        chatContext.socket.onopen = event => {
            getPublicGroup();
        };
        chatContext.socket.onclose = event => {
            console.error('å…³é—­æœåŠ¡å™¨è¿æ¥!');
        };
        chatContext.socket.onerror = event => {
            console.error('è¿æ¥æœåŠ¡å™¨å¤±è´¥!');
        };
    };

    window.onload = () => {
        init();
        layer.prompt({
            formType: 0,
            value: '',
            title: 'è¯·è¾“å…¥ä¸ªåå­—å§~',
        }, function (value, index, elem) {
            if (value === '') {
                layer.msg('è¯·è¾“å…¥ä¸ªåå­—å§~');
            } else {
                layer.close(index);
                register(value.replace(/\s+/g, ""));
            }
        });
        $('.typing').bind('keydown', event => {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMsg();
            }
        })
    };

    layui.use(['laydate', 'laypage', 'layer', 'table', 'carousel', 'upload', 'element'], () => {
    });
</script>
</body>
</html>